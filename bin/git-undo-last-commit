#!/usr/bin/env bash

# git-undo-last-commit - Safely undo the last commit while preserving changes
#
# USAGE:
#   git undo-last-commit
#
# DESCRIPTION:
#   Undoes the most recent commit.
#
#   This script handles both regular commits and merge commits appropriately:
#   - Regular commits: Uses 'git reset --soft HEAD~' to keep changes staged
#   - Merge commits: Uses 'git reset --merge ORIG_HEAD' to undo the merge
#
# FILES CREATED:
#   .git/MY_UNDONE_COMMIT_MSG - Contains the original commit message
#
# EXAMPLES:
#   git undo-last-commit              # Undo the last commit
#   git redo-commit                   # Re-commit, starting with the same message

set -euo pipefail

if [ -t 1 ] && ncolors="$(tput colors 2>/dev/null)" && [ -n "$ncolors" ] && [ "$ncolors" -ge 8 ]; then
	bold=$(printf '\033[1m')
	reset=$(printf '\033[0m')
else
	bold=
	reset=
fi

# https://stackoverflow.com/a/13956422
is_merge ()  {
	return $(( ! $(git rev-list --no-walk --count --merges "$@")));
}

orig_commit="$(git rev-parse HEAD)"

if is_merge HEAD; then
	echo "Merge commit detected. Undoing merge commit $(git rev-parse HEAD) and moving back to $(git rev-parse ORIG_HEAD)."
	echo -e "$ ${bold}git reset --merge ORIG_HEAD${reset}"
	git reset --merge ORIG_HEAD
else
	echo "Not a merge commit. Undoing commit $(git rev-parse HEAD) and moving back to $(git rev-parse HEAD~)."
	echo -e "$ ${bold}git reset --soft HEAD~${reset}"
	git reset --soft HEAD~
fi

echo
echo "Saving commit message to .git/MY_UNDONE_COMMIT_MSG"
echo -e "$ ${bold}git log --format=%B -n 1 \"$orig_commit\" > \"$(git rev-parse --show-toplevel)/.git/MY_UNDONE_COMMIT_MSG\"${reset}"
git log --format=%B -n 1 "$orig_commit" > "$(git rev-parse --show-toplevel)/.git/MY_UNDONE_COMMIT_MSG"

# if .git/branchless/config exists
if [ -f "$(git rev-parse --show-toplevel)/.git/branchless/config" ]; then
	# and git-branchless command is available
	if command -v git-branchless >/dev/null 2>&1; then
		echo
		echo "git-branchless is being used. Removing original commit $orig_commit from the branchless smartlog."
		echo -e "To undo this, run: ${bold}git-branchless unhide $orig_commit${reset}"
		echo -e "$ ${bold}git-branchless hide $orig_commit${reset}"
		git-branchless hide "$orig_commit"
	fi
fi

echo
echo -e "When you are ready to redo the commit, use ${bold}git redo-commit${reset} to start a new commit with the same message."
# shellcheck disable=SC2016
echo -e Or use: "${bold}"'git commit --allow-empty-message --template="$(git rev-parse --show-toplevel)/.git/MY_UNDONE_COMMIT_MSG"'"${reset}"
