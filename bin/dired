#!/usr/bin/env bash

dir=${1:-.}

if [ -e "$dir" ] && ! [ -d "$dir" ]; then
	# If it exists but isn't a directory, use the containing directory.
	dir="$(dirname "$dir")" || exit 2
fi

if [[ $dir != */ ]]; then
	# Make sure it ends with a /, so emacs knows it's a directory.
	# That way, if it doesn't exist yet, emacs will prompt to create magit.
	# (See `doom-create-missing-directories-h` and `akn/no-longer-nonexisting-directory-h`.)
	dir="$dir"/
fi

rm -f ~/.cache/doom/akn-cwd

# If Emacs.app isn't already running, ...
if ! pgrep -f Emacs.app >/dev/null; then
	emacs-term-new "$dir" || exit $?
else
	emacs-term "$dir" || exit $?
fi

# This only works if this script is sourced directly:
#   dired() { . dired "${@:-.}"; }
if dir=$(cat ~/.cache/doom/akn-cwd 2>/dev/null) && [ -n "$dir" ]; then
	pushd -- "$dir" >/dev/null || exit 1
	rm -f ~/.cache/doom/akn-cwd
fi
