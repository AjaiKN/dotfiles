#!/usr/bin/env bash

# set -x

export EMACS_SOCKET_NAME=term

if
	# No args, stdin isn't a tty but stderr is -> something is probably being piped to us
	{ (( $# == 0 )) && [[ ! -t 0 ]] && [[ -t 2 ]]; } ||
		# Single argument: -
		{ (( $# == 1 )) && [[ "$1" == "-" ]]; }
then
	exec epipe -nw
fi

args=()
for arg in "$@"; do
	if [[ "$arg" == "-" ]]; then
		DIR=$(mktemp -d "$TMPDIR/epipe-$$.XXXXXXXXXX")
		out="$DIR/pipe"
		( umask 077; cat >"$out"; )
		args+=("$out")
	else
		args+=("$arg")
	fi
done
set -- "${args[@]}"

if [ -n "$INSIDE_EMACS" ]; then
	exec emacsclient "$@"
fi

# Emacs in the terminal

emacs-daemon-wait
# if no arguments, open dired in the current directory
exec emacsclient -nw "${@:-.}"
