#!/bin/bash
set -eu
# set -x

# https://stebalien.com/blog/epipe/

cleanup() {
	trap - TERM INT EXIT
	if [[ -O "$out" ]]; then
		rm -f "$out" || :
	fi
	if [[ -O "$dir" ]]; then
		rmdir "$dir" || :
	fi
}
trap "cleanup" TERM INT EXIT

# https://crowding.github.io/blog/2014/08/16/replace-less-with-emacs/
the_command=$(ps -o 'command=' -p "$(ps -o 'ppid=' $$)" | sed -e 's/["\\]/\\&/g' -e 's/["\\]/\\&/g')
>&2 echo "$the_command"

# Create a named pipe
dir=$(mktemp -d "$TMPDIR/epipe-$$.XXXXXXXXXX")
out="$dir/pipe"
if [ -z "${EPIPE_USE_FILE:-}" ]; then
	mkfifo -m 0600 "$out"

	emacsclient --eval "(akn/pager-read-pipe \"$out\")" "$@" >/dev/null <&-
else
	(
		umask 077
		cat >"$out"
	)
	emacsclient --eval "(akn/pager-read-pipe-sync \"$out\")" "$@" >/dev/null
fi

if [ -z "${EPIPE_USE_FILE:-}" ]; then
	exec 1>"$out"
	cleanup # Cleanup early. Nobody needs the paths now...
	cat
fi
