#!/usr/bin/env bash
set -eu
# set -x

# https://blog0.steelcandy.org/2022-03-14-paging.html - https://github.com/steelcandy2/empager/
# https://eless.scripter.co/ - https://github.com/kaushalmodi/eless
# https://karthinks.com/software/more-less-emacs/
# https://stebalien.com/blog/epipe/ - https://github.com/Stebalien/named-pipe.el
# https://crowding.github.io/blog/2014/08/16/replace-less-with-emacs/
# https://write.as/mnmlmnl/tid-setting-emacsclient-up-as-a-pager-with-kitty
# https://github.com/lewang/e-sink
# https://old.reddit.com/r/emacs/comments/fk7p49/piping_stdout_to_emacs/

cleanup() {
	trap - TERM INT EXIT
	if [[ -O "$out" ]]; then
		rm -f "$out" || :
	fi
	if [[ -O "$dir" ]]; then
		rmdir "$dir" || :
	fi
}
trap "cleanup" TERM INT EXIT

for arg in "$@"; do
	case "$arg" in
		(-nw|-t|--tty|--no-window-system)
			EPIPE_USE_FILE=1
			;;
	esac
done

# https://crowding.github.io/blog/2014/08/16/replace-less-with-emacs/
# the_command=$(ps -o 'command=' -p "$(ps -o 'ppid=' $$)" | sed -e 's/["\\]/\\&/g' -e 's/["\\]/\\&/g')
# >&2 echo "$the_command"

# Create a named pipe
dir=$(mktemp -d "$TMPDIR/epipe-$$.XXXXXXXXXX")
out="$dir/pipe"
if [ -z "${EPIPE_USE_FILE:-}" ]; then
	if [ -t 1 ]; then
		# stdout is a tty
		mkfifo -m 0600 "$out"
		emacsclient --eval "(akn/pager-read-pipe \"$out\")" "$@" >/dev/null <&-
		exec 1>"$out"
		cleanup # Cleanup early. Nobody needs the paths now...
		cat
	else
		(umask 077; cat >"$out")
		emacsclient "$@" "$out" </dev/tty >&2
		cat "$out"
	fi
else
	if [ -t 1 ]; then
		# stdout is a tty
		(umask 077; cat >"$out")
		emacsclient --eval "(akn/pager-read-pipe-sync \"$out\")" "$@"
	elif [ -t 2 ]; then
		# stdout isn't a tty but stderr is
		(umask 077; cat >"$out")
		emacsclient "$@" "$out" </dev/tty >&2
		cat "$out"
	else
		cat
	fi
fi
